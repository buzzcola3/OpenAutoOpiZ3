name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure buildroot directory exists (submodules or fail)
        run: |
          if [ ! -d buildroot ]; then
            echo "buildroot directory not found. If buildroot is a git submodule, initializing..."
            git submodule update --init --recursive
          fi
          if [ ! -d buildroot ]; then
            echo "Error: buildroot directory is missing. Please add it to the repository or as a submodule."
            exit 1
          fi

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc \
            bison \
            build-essential \
            cpio \
            file \
            flex \
            gawk \
            gettext \
            libelf-dev \
            libncurses5-dev \
            libncurses-dev \
            libssl-dev \
            python3 \
            rsync \
            unzip \
            wget

      - name: Configure Buildroot
        run: make -C buildroot BR2_EXTERNAL="${GITHUB_WORKSPACE}/external" openauto_orangepi_zero3_defconfig

      - name: Build images
        run: make -C buildroot

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            buildroot/output/images/sdcard.img
            buildroot/output/images/Image
            buildroot/output/images/allwinner/sun50i-h618-orangepi-zero3.dtb
            buildroot/output/images/rootfs.ext4
